<!DOCTYPE html>
<html>
<head>
	<meta http-equiv="content-type" content="text/html; charset=UTF-8">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
	<title> AOE2 </title>
	<link rel="icon" href="icon.png">
</head>
<!---------------------------------------------------------------->
<body style="background-color: rgba(31, 45, 48, 0.65)">
	<br>
	<div class="container">
		<div class="row bg-dark shadow-lg">
		  <div class="col">
			  <br>
			<button id="aggiorna" type="button" onclick="aggiorna()" class="btn btn-primary">Update Lobby</button>
			<div id="caricamento" class="spinner-border text-primary" role="status" hidden>
				<span class="sr-only">Loading...</span>
			  </div>
		  </div>
		  <div class="col-6">
			<br>
			<h2 style="text-align:center; color:white"><b>My AOE2 DE Lobby</b> by Render5</h2>
			<b><hr /></b>
		  </div>
		  <div class="col">
			  <br>
			  <h3 style="text-align:center; color:white" onclick="wololoo()">30</h3>
			  <audio id="audiotag1" src="https://www.myinstants.com/media/sounds/sound-9_1.mp3" preload="auto"></audio>
		  </div>
		</div>
		<div class="row bg-dark shadow-lg">
			<div class="col-3">
				<button id="salva_id" type="button" onclick="salva_id(document.getElementById('steam_id_box').value)" class="btn btn-primary">Save ID &emsp;&emsp;</button>
				<hr />
			</div>
			<div class="col-3">
				<input type="number" placeholder="steam id" id="steam_id_box">
				<hr />
			</div>
			<div class="col-6">
			</div>
		</div>
		
		<div class="row bg-dark">
			<div style=" color:white" class="col-md-auto"><h3><b>Lobby Name:</b></h3></div>
			<div class="col-9"><h3 style="color:white" id="lobby_name"></h3></div>
		</div>
		<div class="row bg-dark">
			<div class="col-12">
				<hr />
			</div>
		</div>
		<div class="row bg-dark shadow-lg">
			<div style="text-align:center" class="col-md-auto"><button id="btn1" type="button" onclick="mostra_info(0)" class="btn btn-secondary btn-sm" disabled>info</button></div>
			<div style="text-align:right; color:white" class="col-md-auto"><h4><b>Player 1:&emsp;</b></h4></div>
			<div class="col-9"><h4 style="color:white" id="p1"></h4></div>
		</div>
		<div class="row bg-dark">
			<div style="text-align:center" class="col-md-auto"><button id="btn2" type="button" onclick="mostra_info(1)" class="btn btn-secondary btn-sm" disabled>info</button></div>
			<div style="text-align:right; color:white" class="col-md-auto"><h4><b>Player 2:&emsp;</b></h4></div>
			<div class="col-9"><h4 style="color:white" id="p2"></h4></div>
		</div>
		<div class="row bg-dark">
			<div style="text-align:center" class="col-md-auto"><button id="btn3" type="button" onclick="mostra_info(2)" class="btn btn-secondary btn-sm" disabled>info</button></div>
			<div style="text-align:right; color:white" class="col-md-auto"><h4><b>Player 3:&emsp;</b></h4></div>
			<div class="col-9"><h4 style="color:white" id="p3"></h4></div>
		</div>
		<div class="row bg-dark">
			<div style="text-align:center" class="col-md-auto"><button id="btn4" type="button" onclick="mostra_info(3)" class="btn btn-secondary btn-sm" disabled>info</button></div>
			<div style="text-align:right; color:white" class="col-md-auto"><h4><b>Player 4:&emsp;</b></h4></div>
			<div class="col-9"><h4 style="color:white" id="p4"></h4></div>
		</div>
		<div class="row bg-dark">
			<div style="text-align:center" class="col-md-auto"><button id="btn5" type="button" onclick="mostra_info(4)" class="btn btn-secondary btn-sm" disabled>info</button></div>
			<div style="text-align:right; color:white" class="col-md-auto"><h4><b>Player 5:&emsp;</b></h4></div>
			<div class="col-9"><h4 style="color:white" id="p5"></h4></div>
		</div>
		<div class="row bg-dark">
			<div style="text-align:center" class="col-md-auto"><button id="btn6" type="button" onclick="mostra_info(5)" class="btn btn-secondary btn-sm" disabled>info</button></div>
			<div style="text-align:right; color:white" class="col-md-auto"><h4><b>Player 6:&emsp;</b></h4></div>
			<div class="col-9"><h4 style="color:white" id="p6"></h4></div>
		</div>
		<div class="row bg-dark">
			<div style="text-align:center" class="col-md-auto"><button id="btn7" type="button" onclick="mostra_info(6)" class="btn btn-secondary btn-sm" disabled>info</button></div>
			<div style="text-align:right; color:white" class="col-md-auto"><h4><b>Player 7:&emsp;</b></h4></div>
			<div class="col-9"><h4 style="color:white" id="p7"></h4></div>
		</div>
		<div class="row bg-dark">
			<div style="text-align:center" class="col-md-auto"><button id="btn8" type="button" onclick="mostra_info(7)" class="btn btn-secondary btn-sm" disabled>info</button></div>
			<div style="text-align:right; color:white" class="col-md-auto"><h4><b>Player 8:&emsp;</b></h4></div>
			<div class="col-9"><h4 style="color:white" id="p8"></h4></div>
		</div>
		<br>
		<br>
		<br>
		<div class="row bg-dark">
			<div class="col-12">
				<hr />
			</div>
			<div style="text-align:right; color:white" class="col-2"><h4><b>Player info:&emsp;</b></h4></div>
			<div style="text-align:left; color:white" class="col-10"><h4 id="p_info">-</h4></div>
			<div style="text-align:right; color:white" class="col-2"><h4><b>Fav. Civs:&emsp;</b></h4></div>
			<div style="text-align:left; color:white" class="col-10"><h4 id="fav_civ">-</h4></div>
			<div class="col-12">
				<hr />
			</div>
			<div style="text-align:right; color:white" class="col-2"><h4><b>Last Games:&emsp;</b></h4></div>
			<div style="text-align:left; color:white" class="col-10"><h4 id="last_games">-</h4></div>
			<div class="col-12">
				<hr />
			</div>
			<div style="text-align:right; color:white" class="col-2"><h4><b>1v1 Elo:&emsp;</b></h4></div>
			<div style="text-align:left; color:white" class="col-4"><h4 id="1v1_elo">-</h4></div>
			<div style="text-align:right; color:white" class="col-2"><h4><b>team Elo:&emsp;</b></h4></div>
			<div style="text-align:left; color:white" class="col-4"><h4 id="team_elo">-</h4></div>
		</div>

		<div class="row bg-dark">
			<div id="animazione" class="col-6">
			  asadss
			</div>
		  </div>
</body>

<script type="text/javascript">
	const civilta = [
		"Aztecs",
    	"Berbers",
    	"Britons",
		"Bulgarians",
		"Burgundians",
    	"Burmese",
    	"Byzantines",
    	"Celts",
    	"Chinese",
    	"Cumans",
    	"Ethiopians",
    	"Franks",
    	"Goths",
    	"Huns",
    	"Incas",
    	"Indians",
    	"Italians",
    	"Japanese",
    	"Khmer",
    	"Koreans",
    	"Lithuanians",
    	"Magyars",
    	"Malay",
    	"Malians",
    	"Mayans",
    	"Mongols",
    	"Persians",
    	"Portuguese",
    	"Saracens",
    	"Sicilians",
    	"Slavs",
    	"Spanish",
    	"Tatars",
    	"Teutons",
    	"Turks",
    	"Vietnamese",
    	"Vikings"
	]
	var flag =0
	var giocatori = []
	var giocatori_partite = []
	var giocatori_nome = []
	var bandiera = []
	var drops = []
	var rating = []
	var civs = []
	function get_lobbies(opzioni, callback){
		var xhr = new XMLHttpRequest();
		xhr.open('GET', "https://aoe2.net/api/lobbies", true);
		xhr.responseType = 'json';

		xhr.onload = function(){
		let status = xhr.status
		if(status== 200){
			callback(null, xhr.response)
		}else{
			callback(status)
		}
	}
	xhr.send();
	}



	get_lobbies( null , function(err, data){
		if (err != null){
			console.error(err);
		}else{
			

			var id_steam = JSON.parse(window.localStorage.getItem('id_utente'))
			flag = parseInt(-1)
			for(e=0; e<data.length; e++){
				for(k=0; k < data[e].players.length; k++){
					if(data[e].players[k].steam_id == id_steam){
						flag =  parseInt(e);
					}
				}
			}
			console.log(flag)
			if(JSON.parse(window.localStorage.getItem('id_utente')) == null){
				flag = parseInt(-1)
			}
			if(flag != parseInt(-1)){
				document.getElementById("lobby_name").innerHTML = JSON.stringify(data[flag].name)
				for(m=0; m<data[flag].players.length; m++){
					if(data[flag].players[m].slot_type == "1"){
						document.getElementById("p"+ (m+1)).innerHTML = (data[flag].players[m].name) + "&emsp;Games:&nbsp;" + data[flag].players[m].games + "&emsp;Wins:&nbsp;" + data[flag].players[m].wins + "&emsp;Winrate:&nbsp;" + Math.floor(((data[flag].players[m].wins)/(data[flag].players[m].games))*100) + "&nbsp;%"
						document.getElementById("btn" + (m+1)).disabled = false
						giocatori[m]= data[flag].players[m].steam_id
						giocatori_partite[m]= data[flag].players[m].games
						bandiera[m] = data[flag].players[m].country
						drops[m] = data[flag].players[m].drops
						rating[m] = data[flag].players[m].rating
						giocatori_nome[m] = data[flag].players[m].name
					}else if(data[flag].players[m].slot_type == "3"){
						document.getElementById("p"+ (m+1)).innerHTML = "-&nbsp;AI&nbsp;-"
						giocatori[m]= "AI"
						giocatori_partite[m]= 0
						bandiera[m] = "none"
						drops[m] = "none"
						rating[m] = "none"
						giocatori_nome[m] = "AI"
					}else{
						document.getElementById("p"+ (m+1)).innerHTML = "-&nbsp;Empty&nbsp;-"
						giocatori[m]= "none"
						giocatori_partite[m]= 0
						bandiera[m] = "none"
						drops[m] = "none"
						rating[m] = "none"
						giocatori_nome[m] = "none"
					}
				}
			}else{
				document.getElementById("lobby_name").innerHTML = "No Lobby Found for steam_id =&nbsp;" + id_steam
			}
			
		}
	});

	function salva_id(id){
		window.localStorage.setItem("id_utente", JSON.stringify(id));
	}

	function aggiorna(){
		document.getElementById("caricamento").hidden = false

		get_lobbies( null , function(err, data){
		if (err != null){
			console.error(err);
		}else{
			

			
			for(e=0; e<data.length; e++){
				for(k=0; k < data[e].players.length; k++){
					if(data[e].players[k].steam_id == "76561198085901459" || data[e].players[k].steam_id == "76561198008839394"){
						flag = e;
					}
				}
			}
			console.log(data[flag])
			document.getElementById("lobby_name").innerHTML = JSON.stringify(data[flag].name)
			for(m=0; m<data[flag].players.length; m++){
				if(data[flag].players[m].slot_type == "1"){
					document.getElementById("p"+ (m+1)).innerHTML = (data[flag].players[m].name) + "&emsp;Games:&nbsp;" + data[flag].players[m].games + "&emsp;Wins:&nbsp;" + data[flag].players[m].wins + "&emsp;Winrate:&nbsp;" + Math.floor(((data[flag].players[m].wins)/(data[flag].players[m].games))*100) + "&nbsp;%"
					document.getElementById("btn" + (m+1)).disabled = false
					giocatori[m]= data[flag].players[m].steam_id
					giocatori_partite[m]= data[flag].players[m].games
					bandiera[m] = data[flag].players[m].country
					drops[m] = data[flag].players[m].drops
					rating[m] = data[flag].players[m].rating
					giocatori_nome[m] = data[flag].players[m].name
				}else if(data[flag].players[m].slot_type == "3"){
					document.getElementById("p"+ (m+1)).innerHTML = "-&nbsp;AI&nbsp;-"
					giocatori[m]= "AI"
					giocatori_partite[m]= 0
					bandiera[m] = "none"
					drops[m] = "none"
					rating[m] = "none"
					giocatori_nome[m] = "AI"
				}else{
					document.getElementById("p"+ (m+1)).innerHTML = "-&nbsp;Empty&nbsp;-"
					giocatori[m]= "none"
					giocatori_partite[m]= 0
					bandiera[m] = "none"
					drops[m] = "none"
					rating[m] = "none"
					giocatori_nome[m] = "none"
				}
			}
			document.getElementById("caricamento").hidden = true
		}
	});
	}

	function show_info(id, partite, callback){
		var xhr2 = new XMLHttpRequest();
		xhr2.open('GET', "https://aoe2.net/api/player/matches?game=aoe2de&leaderboard_id=0&start=0&steam_id=" + id + "&count="+partite, true);
		xhr2.responseType = 'json';

		xhr2.onload = function(){
		let status = xhr2.status
		if(status== 200){
			callback(null, xhr2.response)
		}else{
			callback(status)
		}
	}
	xhr2.send();
	}

	function show_elo(id, ladder, callback){
		var xhr3 = new XMLHttpRequest();
		xhr3.open('GET', "https://aoe2.net/api/player/ratinghistory?game=aoe2de&leaderboard_id=" + ladder + "&start=0&steam_id=" + id + "&count=10", true);
		xhr3.responseType = 'json';

		xhr3.onload = function(){
		let status = xhr3.status
		if(status== 200){
			callback(null, xhr3.response)
		}else{
			callback(status)
		}
	}
	xhr3.send();
	}


	function mostra_info(numero){
		show_info( giocatori[numero], giocatori_partite[numero] , function(err, data2){
			if (err != null){
				console.error(err);
			}else{
				console.log(data2)
				for(l=0; l<((giocatori_partite[numero])--); l++){
					console.log("a")
					for(f=0; f<data2[l].num_players; f++){
						if(data2[l].players[f].steam_id == giocatori[numero]){
							civs[l]= data2[l].players[f].civ
						}
					}
				}
				//console.log(civs)
				document.getElementById("fav_civ").innerHTML = mode(civs) +",&nbsp;" + mode(civs)+",&nbsp;" + mode(civs)+",&nbsp;" + mode(civs)+",&nbsp;" + mode(civs)+",&nbsp;" + mode(civs)
				document.getElementById("p_info").innerHTML = giocatori_nome[numero] + "&emsp;Country:&nbsp;" + bandiera[numero] + "&emsp;Rating:&nbsp;" + rating[numero] + "&emsp;Drops:&nbsp;" + drops[numero]
				if(giocatori_partite[numero]>5){
					document.getElementById("last_games").innerHTML = data2[0].name + "<br>" + data2[1].name+ "<br>" + data2[2].name + "<br>" + data2[3].name + "<br>" + data2[4].name
				}
			}
		});

		show_elo( giocatori[numero], 3 , function(err, data3){
			if (err != null){
				console.error(err);
			}else{
				if(data3.length != 0){
					document.getElementById("1v1_elo").innerHTML = "Yes"
				}else{
					document.getElementById("1v1_elo").innerHTML = "No"
				}
			}
		});

		show_elo( giocatori[numero], 4 , function(err, data4){
			if (err != null){
				console.error(err);
			}else{
				if(data4.length != 0){
					document.getElementById("team_elo").innerHTML = "Yes"
				}else{
					document.getElementById("team_elo").innerHTML = "No"
				}
			}
		});
	}



	function mode(array)
	{
		if(array.length == 0)
			return null;
		var modeMap = {};
		var maxEl = array[0], maxCount = 1;
		for(var i = 0; i < array.length; i++)
		{
			var el = array[i];
			if(modeMap[el] == null)
				modeMap[el] = 1;
			else
				modeMap[el]++;  
			if(modeMap[el] > maxCount)
			{
				maxEl = el;
				maxCount = modeMap[el];
			}
		}

		for( var d = 0; d < civs.length; d++){ 
			if ( civs[d] === maxEl) { 
				civs.splice(d, 1);
			}
		}
		console.log(civs)

		for(j=0; j<civilta.length; j++){
			if(j == maxEl){
				return civilta[j]
			}
		}
	}

	function wololoo(){
		document.getElementById('audiotag1').play()
	}

</script>
</html>
